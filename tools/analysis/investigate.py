import requests
from web3 import Web3
from eth_utils import decode_hex, function_signature_to_4byte_selector

CONTRACT_ADDRESS = "0xYourContractAddress"
ETHERSCAN_API_KEY = "YourEtherscanAPIKey"

def get_bytecode(contract_address):
    return '0x608060405234801561001057600080fd5b50600436106100d45760003560e01c80637eca9e1e116100815780639b23d3d91161005b5780639b23d3d9146101e6578063abf6e3dd146101f9578063e2470d501461020c57600080fd5b80637eca9e1e1461019057806392d3e099146101bc578063997072f7146101d157600080fd5b8063442fd224116100b2578063442fd22414610149578063618dc65e1461015c57806374b2b8421461017d57600080fd5b806315dacbea146100d95780633314d891146101045780633bd27df314610124575b600080fd5b6100ec6100e7366004610de6565b61021f565b60405160079190910b81526020015b60405180910390f35b610117610112366004610e4d565b610313565b6040516100fb9190610e80565b6002546001600160a01b03165b6040516001600160a01b0390911681526020016100fb565b610131610157366004610ecd565b61040e565b61016f61016a366004610f72565b610438565b6040516100fb929190611026565b61011761018b366004610e4d565b610556565b6101a361019e36600461105d565b610646565b60405167ffffffffffffffff90911681526020016100fb565b6101cf6101ca3660046110a8565b610745565b005b60005460405160ff90911681526020016100fb565b6100ec6101f4366004610de6565b610a33565b610131610207366004610ecd565b610a78565b6101cf61021a366004611131565b610a88565b6040516001600160a01b038581166024830152848116604483015283166064820152608481018290526000908190819061016790630aed65f560e11b9060a4015b60408051601f198184030181529181526020820180516001600160e01b03166001600160e01b031990941693909317909252905161029e919061119e565b6000604051808303816000865af19150503d80600081146102db576040519150601f19603f3d011682016040523d82523d6000602084013e6102e0565b606091505b5091509150816102f1576015610305565b8080602001905181019061030591906111ba565b60030b979650505050505050565b6060600061032183856111fa565b905060018054905060ff168160ff161061033a57506001545b60006103468583611213565b60ff1667ffffffffffffffff81111561036157610361610ee6565b60405190808252806020026020018201604052801561038a578160200160208202803683370190505b50905060ff85165b8260ff1681101561040357600181815481106103b0576103b061122c565b6000918252602090912001546001600160a01b0316826103d360ff891684611242565b815181106103e3576103e361122c565b6001600160a01b0390921660209283029190910190910152600101610392565b509150505b92915050565b6000818154811061041e57600080fd5b6000918252602090912001546001600160a01b0316905081565b600060606000806101676001600160a01b031663618dc65e60e01b8787604051602401610466929190611255565b60408051601f198184030181529181526020820180516001600160e01b03166001600160e01b03199094169390931790925290516104a4919061119e565b6000604051808303816000865af19150503d80600081146104e1576040519150601f19603f3d011682016040523d82523d6000602084013e6104e6565b606091505b50915091507f4af4780e06fe8cb9df64b0794fa6f01399af979175bb988e35e0e57e594567bc828260405161051c929190611277565b60405180910390a18161054057601560405180602001604052806000815250610544565b6016815b60039190910b97909650945050505050565b6060600061056483856111fa565b905060008054905060ff168160ff161061057d57506000545b60006105898583611213565b60ff1667ffffffffffffffff8111156105a4576105a4610ee6565b6040519080825280602002602001820160405280156105cd578160200160208202803683370190505b50905060ff85165b8260ff1681101561040357600081815481106105f3576105f361122c565b6000918252602090912001546001600160a01b03168261061660ff891684611242565b815181106106265761062661122c565b6001600160a01b03909216602092830291909101909101526001016105d5565b60405163b90fa29d60e01b815267ffffffffffffffff821660048201526000908490849083906001600160a01b0384169063b90fa29d90602401602060405180830381865afa15801561069d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906106c19190611292565b604051634220662760e01b815267ffffffffffffffff821660048201529091506000906001600160a01b03841690634220662790602401602060405180830381865afa158015610715573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107399190611292565b98975050505050505050565b60405163b90fa29d60e01b815267ffffffffffffffff851660048201526000906001600160a01b0388169063b90fa29d90602401602060405180830381865afa158015610796573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107ba9190611292565b604051634220662760e01b815267ffffffffffffffff821660048201529091506000906001600160a01b03881690634220662790602401602060405180830381865afa15801561080e573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108329190611292565b90506000816108428660646112af565b61084c91906112db565b610857906064611310565b90508360070b61086682610daf565b60070b13156108e25760405162461bcd60e51b815260206004820152603e60248201527f54686520736c69707061676520666f722074686973207377617020686173206560448201527f786365656465642074686520746f6c6572616e63652070726f7669646564000060648201526084015b60405180910390fd5b6040516350ed959160e11b815233600482015267ffffffffffffffff8089166024830152841660448201526001600160a01b0389811660648301528a169063a1db2b2290608401600060405180830381600087803b15801561094357600080fd5b505af1158015610957573d6000803e3d6000fd5b5050604051634c9a94ff60e11b81526001600160a01b03898116600483015267ffffffffffffffff861660248301528b16925063993529fe9150604401600060405180830381600087803b1580156109ae57600080fd5b505af11580156109c2573d6000803e3d6000fd5b5050604080513381526001600160a01b038a16602082015267ffffffffffffffff8b81168284015287811660608301528616608082015290517f4ad2affb374ffa33a9e3fdb32e4a79c4369ba2266af914323bbbb357fb516c5493509081900360a0019150a1505050505050505050565b6040516001600160a01b038581166024830152848116604483015283166064820152608481018290526000908190819061016790639b23d3d960e01b9060a401610260565b6001818154811061041e57600080fd5b6002546001600160a01b0316610ae05760405162461bcd60e51b815260206004820181905260248201527f496e7465726368616e676520746f6b656e206e6f7420636f6e6669677572656460448201526064016108d9565b60005b600054811015610b4757336001600160a01b031660008281548110610b0a57610b0a61122c565b6000918252602090912001546001600160a01b031603610b3f578360405163350e6efd60e01b81526004016108d9919061133f565b600101610ae3565b5060008054600180820183557f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56390910180543373ffffffffffffffffffffffffffffffffffffffff199182161790915581548083018355919092527fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf60180549091166001600160a01b038381169182179092556002546040516329ede7c760e11b81529216600483015282916353dbcf8e90602401600060405180830381600087803b158015610c1657600080fd5b505af1158015610c2a573d6000803e3d6000fd5b505050507f05ac2d22d7151fdb80b6d6c40f28b2417e5afe6e49f6efc94d4a3b2d30f165cf828585600260009054906101000a90046001600160a01b0316856001600160a01b0316633d35d7ba6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610ca6573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610cca9190611292565b866001600160a01b031663226fd9eb6040518163ffffffff1660e01b8152600401602060405180830381865afa158015610d08573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610d2c9190611292565b876001600160a01b0316636ec437496040518163ffffffff1660e01b8152600401602060405180830381865afa158015610d6a573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610d8e9190611352565b604051610da1979695949392919061136f565b60405180910390a150505050565b6000808260070b1215610dca57610dc5826113cb565b610408565b5090565b6001600160a01b0381168114610de357600080fd5b50565b60008060008060808587031215610dfc57600080fd5b8435610e0781610dce565b93506020850135610e1781610dce565b92506040850135610e2781610dce565b9396929550929360600135925050565b803560ff81168114610e4857600080fd5b919050565b60008060408385031215610e6057600080fd5b610e6983610e37565b9150610e7760208401610e37565b90509250929050565b6020808252825182820181905260009190848201906040850190845b81811015610ec15783516001600160a01b031683529284019291840191600101610e9c565b50909695505050505050565b600060208284031215610edf57600080fd5b5035919050565b634e487b7160e01b600052604160045260246000fd5b600067ffffffffffffffff80841115610f1757610f17610ee6565b604051601f8501601f19908116603f01168101908282118183101715610f3f57610f3f610ee6565b81604052809350858152868686011115610f5857600080fd5b858560208301376000602087830101525050509392505050565b60008060408385031215610f8557600080fd5b8235610f9081610dce565b9150602083013567ffffffffffffffff811115610fac57600080fd5b8301601f81018513610fbd57600080fd5b610fcc85823560208401610efc565b9150509250929050565b60005b83811015610ff1578181015183820152602001610fd9565b50506000910152565b60008151808452611012816020860160208601610fd6565b601f01601f19169290920160200192915050565b82815260406020820152600061103f6040830184610ffa565b949350505050565b67ffffffffffffffff81168114610de357600080fd5b60008060006060848603121561107257600080fd5b833561107d81610dce565b9250602084013561108d81610dce565b9150604084013561109d81611047565b809150509250925092565b60008060008060008060c087890312156110c157600080fd5b86356110cc81610dce565b955060208701356110dc81610dce565b945060408701356110ec81611047565b935060608701356110fc81610dce565b9250608087013561110c81611047565b915060a0870135600781900b811461112357600080fd5b809150509295509295509295565b60008060006060848603121561114657600080fd5b833567ffffffffffffffff81111561115d57600080fd5b8401601f8101861361116e57600080fd5b61117d86823560208401610efc565b935050602084013561118e81610dce565b9150604084013561109d81610dce565b600082516111b0818460208701610fd6565b9190910192915050565b6000602082840312156111cc57600080fd5b81518060030b81146111dd57600080fd5b9392505050565b634e487b7160e01b600052601160045260246000fd5b60ff8181168382160190811115610408576104086111e4565b60ff8281168282160390811115610408576104086111e4565b634e487b7160e01b600052603260045260246000fd5b81810381811115610408576104086111e4565b6001600160a01b038316815260406020820152600061103f6040830184610ffa565b821515815260406020820152600061103f6040830184610ffa565b6000602082840312156112a457600080fd5b81516111dd81611047565b67ffffffffffffffff8181168382160280821691908281146112d3576112d36111e4565b505092915050565b600067ffffffffffffffff8084168061130457634e487b7160e01b600052601260045260246000fd5b92169190910492915050565b600782810b9082900b03677fffffffffffffff198112677fffffffffffffff82131715610408576104086111e4565b6020815260006111dd6020830184610ffa565b60006020828403121561136457600080fd5b81516111dd81610dce565b60006001600160a01b03808a16835260e0602084015261139260e084018a610ffa565b978116604084015295861660608301525067ffffffffffffffff93841660808201529190921660a0820152911660c09091015292915050565b60008160070b677fffffffffffffff1981036113e9576113e96111e4565b6000039291505056fea2646970667358221220b772b56116a0d94ddcea1796b3963cec9973fcc1aa80e714d2f2be91a261e28764736f6c63430008180033'
  #  return '0x608060405234801561000f575f80fd5b506001805f806006811115610027576100266101b6565b5b6006811115610039576100386101b6565b5b81526020019081526020015f2081905550600260015f60016006811115610063576100626101b6565b5b6006811115610075576100746101b6565b5b81526020019081526020015f2081905550600460015f6002600681111561009f5761009e6101b6565b5b60068111156100b1576100b06101b6565b5b81526020019081526020015f2081905550600860015f600360068111156100db576100da6101b6565b5b60068111156100ed576100ec6101b6565b5b81526020019081526020015f2081905550601060015f60046006811115610117576101166101b6565b5b6006811115610129576101286101b6565b5b81526020019081526020015f2081905550602060015f60056006811115610153576101526101b6565b5b6006811115610165576101646101b6565b5b81526020019081526020015f2081905550604060015f60068081111561018e5761018d6101b6565b5b60068111156101a05761019f6101b6565b5b81526020019081526020015f20819055506101e3565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602160045260245ffd5b6103dc806101f05f395ff3fe608060405234801561000f575f80fd5b5060043610610029575f3560e01c8063b7f058361461002d575b5f80fd5b610035610037565b005b5f805f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506100b76003806040518060400160405280600681526020017f30783030303000000000000000000000000000000000000000000000000000008152506100ba565b50565b6100c2610300565b60405180604001604052806100d6866100f1565b81526020016100e5858561012f565b81525090509392505050565b5f60015f83600681111561010857610107610379565b5b600681111561011a57610119610379565b5b81526020019081526020015f20549050919050565b61013761031f565b5f600481111561014a57610149610379565b5b83600481111561015d5761015c610379565b5b03610177576001815f0190151590811515815250506102fa565b6001600481111561018b5761018a610379565b5b83600481111561019e5761019d610379565b5b036101ff575f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff16816020019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250506102f9565b6002600481111561021357610212610379565b5b83600481111561022657610225610379565b5b03610239578181604001819052506102f8565b6003600481111561024d5761024c610379565b5b8360048111156102605761025f610379565b5b03610273578181606001819052506102f7565b60048081111561028657610285610379565b5b83600481111561029957610298610379565b5b036102f6575f8054906101000a900473ffffffffffffffffffffffffffffffffffffffff16816080019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff16815250505b5b5b5b5b92915050565b60405180604001604052805f815260200161031961031f565b81525090565b6040518060a001604052805f151581526020015f73ffffffffffffffffffffffffffffffffffffffff16815260200160608152602001606081526020015f73ffffffffffffffffffffffffffffffffffffffff1681525090565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602160045260245ffdfea2646970667358221220df90d93acd651c33edc2c0097eb35f4fc2327ed45655ed5d41c1a946af6cc13b64736f6c63430008190033'
TARGET_ADDRESS = "0x167"
def opcode_to_human(opcode):
    return Web3.toText(bytes([opcode]))
def check_address_call(instructions, target_address):
    target_address_hex = target_address.lower()
    bytecode_str = "".join(format(x, "02x") for _, x in instructions)

    call_opcodes = ['f1', 'f2', 'f4', 'fa']
    for i in range(len(instructions) - 20):
        if instructions[i][1] in [int(op, 16) for op in call_opcodes]:
            potential_address = bytecode_str[i*2:(i*2) + 40]
            print(potential_address)
            if potential_address.endswith(target_address_hex):
                return True
    return False

def disassemble_bytecode(bytecode):
    bytecode_bytes = decode_hex(bytecode)
    instructions = []
    i = 0
    while i < len(bytecode_bytes):
        opcode = bytecode_bytes[i]
        instructions.append((i, opcode))
        i += 1
    return instructions
def check_function_call(instructions, method_id):
    method_id_hex = decode_hex(method_id)
    for index, opcode in instructions:
     #   print('---------')
     #   print(instructions[index:index + 4])
     #   print(list(method_id_hex))
     #   print('---------')
        if instructions[index:index + 4] == list(method_id_hex):
            return True
    return False

def main():
    bytecode = get_bytecode(CONTRACT_ADDRESS)
    print(f"Bytecode: {bytecode}")
    instructions = disassemble_bytecode(bytecode)
    print(f"Disassembled instructions: {instructions}")
    function_signature = "getTokenKey(address,uint256)"
    method_id = function_signature_to_4byte_selector(function_signature).hex()
    print(f"Method ID for {function_signature}: {method_id}")
    is_called = check_address_call(instructions, TARGET_ADDRESS)
    if is_called:
        print(f"The address {TARGET_ADDRESS} is called in the contract.")
    else:
        print(f"The address {TARGET_ADDRESS} is NOT called in the contract.")
    is_present = check_function_call(instructions, method_id)
    if is_present:
        print(f"The function {function_signature} is called in the contract.")
    else:
        print(f"The function {function_signature} is NOT called in the contract.")

if __name__ == "__main__":
    main()
